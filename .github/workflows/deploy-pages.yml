name: Deploy DATAEXSYS-Genesis Website

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    name: Build LaTeX + Doxygen Docs
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Install Doxygen + Graphviz
      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz

      # 3️⃣ Setup TeX Live + LaTeXML
      - name: Setup TeX Live
        uses: teatimeguest/setup-texlive-action@v3
        with:
          packages: scheme-small collection-fontsrecommended latexml

      # 4️⃣ Create output directories
      - name: Create output directory
        run: mkdir -p _site/docs

      # 5️⃣ Build LaTeX FYP to HTML
      - name: Build LaTeX Report to HTML
        run: |
          # Make sure the path to your main.tex is correct
          latexmlc --dest=_site/index.html F25_079/main.tex

      # 6️⃣ Generate Doxygen documentation
      - name: Create Doxyfile and Build Code Docs
        run: |
          cat <<EOF > Doxyfile
          PROJECT_NAME      = "DATAEXSYS-Genesis"
          OUTPUT_DIRECTORY  = _site/docs
          INPUT             = src inc
          RECURSIVE         = YES
          FILE_PATTERNS     = *.h *.cpp
          HAVE_DOT          = YES
          GENERATE_LATEX    = NO
          EXTRACT_ALL       = YES
          QUIET             = YES
          EOF

          doxygen Doxyfile

      # 7️⃣ Setup GitHub Pages environment
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v5

      # 8️⃣ Upload artifact (combined _site folder)
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site'

  deploy:
    name: Deploy Website
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
